<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TradingView Paper Trading Logger v7 ‚Äî IST Dashboard</title>
  <style>
    :root{
      --bg:#0f1623; --card:#151e2e; --muted:#8aa0b6; --fg:#e5f0ff;
      --green:#22c55e; --red:#ef4444; --amber:#f59e0b; --blue:#60a5fa; --pill:#23314b;
      --border:#25324a; --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:500 15px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--blue);text-decoration:none}
    .wrap{max-width:1800px;margin:24px auto;padding:0 16px}
    .grid{display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    h1{margin:0 0 8px;font-size:22px;font-weight:700}
    h2{margin:0 0 8px;font-size:18px}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;background:#1e293b;color:#e2e8f0;border:1px solid var(--border);cursor:pointer;font-size:14px;text-decoration:none;display:inline-block}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:#3b82f6;border-color:#3b82f6}
    .btn.danger{background:#dc2626;border-color:#dc2626}
    .btn.small{padding:4px 8px;font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;background:var(--pill);font-size:12px}
    .pill.buy{background:#1c2d1e;color:#b7ffb4}
    .pill.sell{background:#3a1a1a;color:#ffb3b3}
    .pill.open{background:#2d2a1a;color:#ffeb3b}
    .pill.closed{background:#1a2d2a;color:#4ade80}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:6px 8px;border-bottom:1px solid var(--border);vertical-align:top;white-space:nowrap}
    th{color:#c9d7ee;text-align:left;position:sticky;top:0;background:var(--card);z-index:1;font-weight:600}
    th.sortable{cursor:pointer;user-select:none}
    th.sortable:hover{background:#1e293b}
    th.sorted-asc::after{content:" ‚Üë";color:var(--blue)}
    th.sorted-desc::after{content:" ‚Üì";color:var(--blue)}
    td.right{text-align:right}
    td.center{text-align:center}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px}
    .kpi .card{padding:14px}
    .kpi .v{font-size:24px;font-weight:800;margin:4px 0}
    .scroll{max-height:600px;overflow:auto;border-radius:10px}
    .small{font-size:13px}
    .positive{color:var(--green)}
    .negative{color:var(--red)}
    .filters{margin-bottom:16px;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:12px}
    input,select{background:#0f172a;border:1px solid var(--border);color:#e5f0ff;border-radius:8px;padding:6px 8px;margin:4px;font-size:14px}
    input[type="date"]{padding:5px 8px}
    code{font-family:var(--mono);background:#0b1320;border:1px solid var(--border);padding:2px 6px;border-radius:8px}
    .badge{background:#374151;color:#e5e7eb;padding:1px 6px;border-radius:4px;font-size:11px;font-weight:600}
    .filter-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;align-items:end}
    .filter-group{display:flex;flex-direction:column;gap:4px}
    .filter-group label{font-size:13px;color:var(--muted);font-weight:500}
    .summary-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;margin-top:12px}
    .summary-item{text-align:center;padding:8px;background:#0f172a;border-radius:8px}
    .summary-item .value{font-size:18px;font-weight:700;margin:2px 0}
    .summary-item .label{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap grid">

  <!-- Header -->
  <div class="row" style="justify-content:space-between;align-items:center">
    <h1>TradingView Paper Trading Logger v7 ‚Äî <span class="muted">IST Dashboard</span></h1>
    <div class="row">
      <button class="btn primary" onclick="addFunds()">üí∞ Add Funds</button>
      <button class="btn danger" onclick="clearTrades()">üóëÔ∏è Clear Trades</button>
      <button class="btn" onclick="location.reload()">üîÑ Refresh</button>
    </div>
  </div>

  <!-- Filters and Sorting -->
  <div class="filters">
    <h2 style="margin:0 0 12px">üîç Filters & Sorting</h2>
    <form method="get" action="/dashboard" id="filterForm">
      <div class="filter-row">
        <div class="filter-group">
          <label>From Date (IST)</label>
          <input type="date" name="from_date" value="{{ from_date }}" />
        </div>
        <div class="filter-group">
          <label>To Date (IST)</label>
          <input type="date" name="to_date" value="{{ to_date }}" />
        </div>
        <div class="filter-group">
          <label>Status</label>
          <select name="filter_status">
            <option value="all" {{ 'selected' if filter_status == 'all' else '' }}>All Trades</option>
            <option value="open" {{ 'selected' if filter_status == 'open' else '' }}>Open Only</option>
            <option value="closed" {{ 'selected' if filter_status == 'closed' else '' }}>Closed Only</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Side</label>
          <select name="filter_side">
            <option value="all" {{ 'selected' if filter_side == 'all' else '' }}>Buy & Sell</option>
            <option value="buy" {{ 'selected' if filter_side == 'buy' else '' }}>Buy Only</option>
            <option value="sell" {{ 'selected' if filter_side == 'sell' else '' }}>Sell Only</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Sort By</label>
          <select name="sort_by">
            <option value="date" {{ 'selected' if sort_by == 'date' else '' }}>Date</option>
            <option value="symbol" {{ 'selected' if sort_by == 'symbol' else '' }}>Symbol</option>
            <option value="pnl" {{ 'selected' if sort_by == 'pnl' else '' }}>P&L</option>
            <option value="status" {{ 'selected' if sort_by == 'status' else '' }}>Status</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Order</label>
          <select name="sort_order">
            <option value="desc" {{ 'selected' if sort_order == 'desc' else '' }}>Newest First</option>
            <option value="asc" {{ 'selected' if sort_order == 'asc' else '' }}>Oldest First</option>
          </select>
        </div>
        <div class="filter-group">
          <label>&nbsp;</label>
          <button type="submit" class="btn primary">Apply</button>
        </div>
        <div class="filter-group">
          <label>&nbsp;</label>
          <a href="/dashboard" class="btn">Clear</a>
        </div>
      </div>
    </form>
    
    <!-- Summary Stats -->
    <div class="summary-row">
      <div class="summary-item">
        <div class="value">{{ total_trades }}</div>
        <div class="label">Total Trades</div>
      </div>
      <div class="summary-item">
        <div class="value positive">{{ open_trades }}</div>
        <div class="label">Open</div>
      </div>
      <div class="summary-item">
        <div class="value">{{ closed_trades }}</div>
        <div class="label">Closed</div>
      </div>
      <div class="summary-item">
        <div class="value {{ 'positive' if total_pnl > 0 else 'negative' if total_pnl < 0 else '' }}">
          {% if total_pnl %}‚Çπ{{ "{:+,.2f}".format(total_pnl) }}{% else %}‚Çπ0.00{% endif %}
        </div>
        <div class="label">Total P&L</div>
      </div>
      <div class="summary-item">
        <div class="value">{{ ledger_count }}</div>
        <div class="label">Ledger Entries</div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi">
    <div class="card">
      <div class="muted small">üí∞ Wallet Balance</div>
      <div class="v mono">‚Çπ {{ "{:,.2f}".format(wallet.balance) }}</div>
      <div class="muted small">{{ wallet.currency }} ‚Ä¢ Available funds</div>
    </div>
    <div class="card">
      <div class="muted small">üìä Position Size (15%)</div>
      <div class="v mono">‚Çπ {{ "{:,.2f}".format(wallet.balance * 0.15) }}</div>
      <div class="muted small">Per ENTRY trade allocation</div>
    </div>
    <div class="card">
      <div class="muted small">üéØ Success Rate</div>
      <div class="v mono">
        {% if closed_trades > 0 %}
          {{ "{:.1f}%".format((closed_trades - [t for t in trades if t.status == 'CLOSED' and (t.realized_pnl or 0) < 0]|length) / closed_trades * 100) }}
        {% else %}
          ‚Äî
        {% endif %}
      </div>
      <div class="muted small">Profitable trades ratio</div>
    </div>
    <div class="card">
      <div class="muted small">üîÑ Pine Script Version</div>
      <div class="v">v7 Auto</div>
      <div class="muted small">15% allocation, fixed T1</div>
    </div>
    <div class="card">
      <div class="muted small">üîë Webhook Secret</div>
      <div class="v"><code>{{ secret_hint }}</code></div>
      <div class="muted small">For TradingView alerts</div>
    </div>
  </div>

  <!-- Consolidated Trades Table -->
  <div class="card">
    <h2>üìã Trades ({{ total_trades }} total)</h2>
    <div class="scroll">
      <table>
        <thead>
        <tr>
          <th class="sortable" onclick="sortTable('date')">Date Time (IST) {{ '‚Üì' if sort_by == 'date' and sort_order == 'desc' else '‚Üë' if sort_by == 'date' and sort_order == 'asc' else '' }}</th>
          <th>Event</th>
          <th class="sortable" onclick="sortTable('symbol')">Symbol {{ '‚Üì' if sort_by == 'symbol' and sort_order == 'desc' else '‚Üë' if sort_by == 'symbol' and sort_order == 'asc' else '' }}</th>
          <th>TF</th>
          <th class="right">High & Low</th>
          <th class="right">SL</th>
          <th class="right">Entry</th>
          <th class="right">Target</th>
          <th class="right">Exit</th>
          <th class="right sortable" onclick="sortTable('pnl')">P&L {{ '‚Üì' if sort_by == 'pnl' and sort_order == 'desc' else '‚Üë' if sort_by == 'pnl' and sort_order == 'asc' else '' }}</th>
          <th class="sortable" onclick="sortTable('status')">Status {{ '‚Üì' if sort_by == 'status' and sort_order == 'desc' else '‚Üë' if sort_by == 'status' and sort_order == 'asc' else '' }}</th>
          <th class="right">Wallet After</th>
          <th>Tag</th>
        </tr>
        </thead>
        <tbody>
        {% if trades|length == 0 %}
          <tr><td colspan="13" class="muted center" style="text-align:center;padding:20px">
            No trades found. 
            {% if from_date or to_date or filter_status != 'all' or filter_side != 'all' %}
              Try adjusting the filters or 
            {% endif %}
            send webhook from TradingView to start logging.
          </td></tr>
        {% else %}
          {% for trade in trades %}
          <tr>
            <td class="mono small">{{ trade.ts_ist_12h or "‚Äî" }}</td>
            <td>
              {% if trade.side == 'BUY' %}<span class="pill buy">BUY</span>
              {% elif trade.side == 'SELL' %}<span class="pill sell">SELL</span>
              {% else %}<span class="pill">{{ trade.side or "‚Äî" }}</span>{% endif %}
            </td>
            <td class="mono">{{ trade.symbol or "‚Äî" }}</td>
            <td class="mono small">{{ trade.tf or "‚Äî" }}</td>
            <td class="right mono small">
              {% if trade.sigH or trade.sigL %}
                {% if trade.sigH %}H: {{ "{:.2f}".format(trade.sigH) }}<br>{% endif %}
                {% if trade.sigL %}L: {{ "{:.2f}".format(trade.sigL) }}{% endif %}
              {% else %}‚Äî{% endif %}
            </td>
            <td class="right mono small">
              {% if trade.sl %}{{ "{:.2f}".format(trade.sl) }}{% else %}‚Äî{% endif %}
            </td>
            <td class="right mono">
              {% if trade.entry_price %}‚Çπ {{ "{:.2f}".format(trade.entry_price) }}{% else %}‚Äî{% endif %}
            </td>
            <td class="right mono small">
              {% if trade.t1 %}T1: {{ "{:.2f}".format(trade.t1) }}<br>{% endif %}
              {% if trade.t2 %}T2: {{ "{:.2f}".format(trade.t2) }}{% endif %}
              {% if not (trade.t1 or trade.t2) %}‚Äî{% endif %}
            </td>
            <td class="right mono">
              {% if trade.exit_price %}
                ‚Çπ {{ "{:.2f}".format(trade.exit_price) }}<br>
                <span class="small muted">{{ trade.exit_ts_ist_12h }}</span>
              {% else %}‚Äî{% endif %}
            </td>
            <td class="right mono {{ 'positive' if (trade.realized_pnl or 0) > 0 else 'negative' if (trade.realized_pnl or 0) < 0 else '' }}">
              {% if trade.realized_pnl %}‚Çπ {{ "{:+,.2f}".format(trade.realized_pnl) }}{% else %}
                {% if trade.status == 'OPEN' %}<span class="muted">Pending</span>{% else %}‚Äî{% endif %}
              {% endif %}
            </td>
            <td>
              {% if trade.status == 'OPEN' %}<span class="pill open">OPEN</span>
              {% elif trade.status == 'CLOSED' %}<span class="pill closed">CLOSED</span>
              {% else %}<span class="pill">{{ trade.status or "‚Äî" }}</span>{% endif %}
            </td>
            <td class="right mono">
              {% if trade.wallet_after_exit %}‚Çπ {{ "{:,.2f}".format(trade.wallet_after_exit) }}
              {% elif trade.wallet_after_entry %}‚Çπ {{ "{:,.2f}".format(trade.wallet_after_entry) }}
              {% else %}‚Äî{% endif %}
            </td>
            <td class="mono small">{{ trade.tag or "‚Äî" }}</td>
          </tr>
          {% endfor %}
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Wallet Ledger -->
  <div class="card">
    <h2>üí≥ Wallet Ledger ({{ ledger_count }} entries)</h2>
    <div class="scroll">
      <table>
        <thead>
        <tr>
          <th>Time (IST)</th>
          <th>Type</th>
          <th>Tag</th>
          <th>Side</th>
          <th class="right">Qty</th>
          <th class="right">Price</th>
          <th class="right">Amount</th>
          <th class="right">Balance After</th>
        </tr>
        </thead>
        <tbody>
        {% if ledger|length == 0 %}
          <tr><td colspan="8" class="muted center" style="text-align:center;padding:20px">No wallet transactions found. {% if from_date or to_date %}Try adjusting the date filter.{% endif %}</td></tr>
        {% else %}
          {% for entry in ledger %}
          <tr>
            <td class="mono small">{{ entry.ts_ist_12h or "‚Äî" }}</td>
            <td class="mono small">
              {% if entry.type == 'ENTRY' %}<span class="pill" style="background:#1c2d1e;color:#b7ffb4">{{ entry.type }}</span>
              {% elif entry.type == 'TARGET1' %}<span class="pill" style="background:#2f2a18;color:#ffe4a6">{{ entry.type }}</span>
              {% elif entry.type == 'STOPLOSS' %}<span class="pill" style="background:#3a1a1a;color:#ffb3b3">{{ entry.type }}</span>
              {% elif entry.type == 'INITIAL_DEPOSIT' %}<span class="pill" style="background:#1a4d4a;color:#6ee7b7">DEPOSIT</span>
              {% else %}<span class="pill">{{ entry.type or "‚Äî" }}</span>{% endif %}
            </td>
            <td class="mono small">{{ entry.tag or "‚Äî" }}</td>
            <td class="mono small">{{ entry.side or "‚Äî" }}</td>
            <td class="right mono small">
              {% if entry.qty %}{{ "{:.6f}".format(entry.qty).rstrip('0').rstrip('.') }}{% else %}‚Äî{% endif %}
            </td>
            <td class="right mono small">
              {% if entry.price %}‚Çπ {{ "{:.2f}".format(entry.price) }}{% else %}‚Äî{% endif %}
            </td>
            <td class="right mono {{ 'positive' if (entry.amount or 0) > 0 else 'negative' if (entry.amount or 0) < 0 else '' }}">
              {% if entry.amount %}‚Çπ {{ "{:+,.2f}".format(entry.amount) }}{% else %}‚Äî{% endif %}
            </td>
            <td class="right mono">
              {% if entry.balance_after %}‚Çπ {{ "{:,.2f}".format(entry.balance_after) }}{% else %}‚Äî{% endif %}
            </td>
          </tr>
          {% endfor %}
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- System Info -->
  <div class="card">
    <h2>üîß System Information</h2>
    <div class="row" style="gap:24px;flex-wrap:wrap">
      <div>
        <strong>Webhook Endpoint:</strong> 
        <code>POST /tv-webhook</code>
      </div>
      <div>
        <strong>Strategy:</strong> 
        <span class="muted">15% balance per ENTRY, close on TARGET1/STOPLOSS</span>
      </div>
      <div>
        <strong>Database:</strong> 
        <span class="muted">SQLite v7 schema with consolidated view</span>
      </div>
      <div>
        <strong>Pine Script:</strong> 
        <span class="muted">v7 Auto (fixed T1, entry on untouched close)</span>
      </div>
    </div>
    
    <div style="margin-top:16px">
      <details>
        <summary style="cursor:pointer;color:var(--blue)">üìù Sample Webhook JSON (Pine v7)</summary>
        <pre style="background:#0b1320;padding:12px;border-radius:8px;margin-top:8px;overflow:auto"><code>{
  "secret": "{{ secret_hint }}",
  "event": "ENTRY",
  "side": "BUY",
  "symbol": "BTCUSDT",
  "tf": "3",
  "price": 111000.12,
  "sigHigh": 111200.0,
  "sigLow": 110900.0,
  "sl": 110900.0,
  "t1": 111800.0,
  "t2": null,
  "tag": "buy-1234567890"
}</code></pre>
      </details>
      
      <details style="margin-top:8px">
        <summary style="cursor:pointer;color:var(--blue)">üìã v7 Updates</summary>
        <ul style="margin:8px 0;padding-left:20px;color:var(--muted);font-size:14px">
          <li><strong>15% allocation:</strong> Each trade uses 15% of wallet balance</li>
          <li><strong>Consolidated view:</strong> One row per trade instead of separate ENTRY/EXIT rows</li>
          <li><strong>Enhanced filtering:</strong> Date range, status, side, and sorting options</li>
          <li><strong>12-hour time format:</strong> IST timestamps in AM/PM format</li>
          <li><strong>Complete ledger:</strong> All wallet transactions without limits</li>
          <li><strong>Success rate tracking:</strong> Profitable trades percentage</li>
        </ul>
      </details>
    </div>
  </div>

</div>

<script>
// Auto-refresh every 60 seconds
setTimeout(() => location.reload(), 60000);

// Sort table function
function sortTable(column) {
  const form = document.getElementById('filterForm');
  const sortBy = document.querySelector('[name="sort_by"]');
  const sortOrder = document.querySelector('[name="sort_order"]');
  
  if (sortBy.value === column) {
    // Toggle order if same column
    sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc';
  } else {
    // New column, default to desc
    sortBy.value = column;
    sortOrder.value = 'desc';
  }
  
  form.submit();
}

// Clear all trades function
async function clearTrades() {
  if (!confirm('‚ö†Ô∏è Clear ALL trades and events? This cannot be undone!\n\nWallet balance will be preserved but all trade history will be lost.')) {
    return;
  }
  
  try {
    const response = await fetch('/clear-trades', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    
    const result = await response.json();
    
    if (result.status === 'ok') {
      alert(`‚úÖ ${result.message}\nWallet Balance: ‚Çπ${result.wallet_balance.toLocaleString()}`);
      location.reload();
    } else {
      alert(`‚ùå Error: ${result.message}`);
    }
  } catch (error) {
    alert(`‚ùå Network error: ${error.message}`);
  }
}

// Add funds function
async function addFunds() {
  const amount = prompt('üí∞ Enter amount to add to wallet (‚Çπ):');
  
  if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
    if (amount !== null) alert('‚ùå Please enter a valid positive amount');
    return;
  }
  
  const reason = prompt('üìù Enter reason for deposit (optional):', 'MANUAL_DEPOSIT') || 'MANUAL_DEPOSIT';
  
  try {
    const response = await fetch('/add-funds', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        amount: parseFloat(amount),
        reason: reason
      })
    });
    
    const result = await response.json();
    
    if (result.status === 'ok') {
      alert(`‚úÖ ${result.message}\n\nBefore: ‚Çπ${result.balance_before.toLocaleString()}\nAfter: ‚Çπ${result.balance_after.toLocaleString()}`);
      location.reload();
    } else {
      alert(`‚ùå Error: ${result.message}`);
    }
  } catch (error) {
    alert(`‚ùå Network error: ${error.message}`);
  }
}
</script>

</body>
</html>